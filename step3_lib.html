<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>EOF Gap-Filling Accessory Modules Code &mdash; HABS Forecast Model 1.0 documentation</title>
    
    <link rel="stylesheet" href="_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="top" title="HABS Forecast Model 1.0 documentation" href="index.html" />
    <link rel="up" title="Satellite Data Processing" href="hab_project.html" />
    <link rel="next" title="Control Script Documentation" href="control_fn.html" />
    <link rel="prev" title="EOF Gap-Filling Accessory Modules Documentation" href="step3_fn.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="control_fn.html" title="Control Script Documentation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="step3_fn.html" title="EOF Gap-Filling Accessory Modules Documentation"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">HABS Forecast Model 1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="hab_project.html" accesskey="U">Satellite Data Processing</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="eof-gap-filling-accessory-modules-code">
<h1>EOF Gap-Filling Accessory Modules Code<a class="headerlink" href="#eof-gap-filling-accessory-modules-code" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-python"><div class="highlight"><pre><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;**Library of functions for processing HABs satellite data**</span>

<span class="sd">**Description:**</span>
<span class="sd">    This module library supports the processing of satellite data</span>
<span class="sd">    for Phase 2 of NASA grant #NNX14AC42G, &quot;Merging Satellite and</span>
<span class="sd">    Numerical Model Data in the California Current to Create Continuous</span>
<span class="sd">    Imagery and Forecasts of Harmful Algal Blooms.&quot;</span>

<span class="sd">**Python module dependencies**</span>
<span class="sd">    * netCDF4</span>
<span class="sd">    * numpy</span>
<span class="sd">    * pdb</span>
<span class="sd">    * os</span>
<span class="sd">    * datetime</span>
<span class="sd">    * time</span>
<span class="sd">    * scipy</span>
<span class="sd">    * subprocess</span>
<span class="sd">    * glob</span>
<span class="sd">    * math</span>
<span class="sd">    * paramiko</span>
<span class="sd">    * sys</span>

<span class="sd">**Creator**</span>
<span class="sd">    Dale Robinson, CoastWatch WCRN</span>

<span class="sd">**History**</span>
<span class="sd">    | Most functions modified Nov. 2015 from functions by Fred Barr (CeNCOOS)</span>
<span class="sd">    | Modified for new (mini) server March 2016</span>
<span class="sd">    | Added Sphinx documentation April 2016</span>

<span class="sd">**Development software versions**</span>
<span class="sd">    * Mac OSX, version 10.11.3</span>
<span class="sd">    * Python 2.7.11 :: Anaconda 2.4.0</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="k">def</span> <span class="nf">netcdfwrite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mytime</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**File writing function**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        The function is deprecated and replaced by write_filled_nc(). It was</span>
<span class="sd">        used to write the netCDF files that contain the EOF-filled and ROMS</span>
<span class="sd">        resoliution-downsampled data. These files would be used to for the</span>
<span class="sd">        forecast portion of the process. CoastWatch does not generate the</span>
<span class="sd">        forecasts.</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        netcdfwrite(data, mytime, lat, lon, mask, var, dineofWorkDir):</span>

<span class="sd">    **Args:**</span>
<span class="sd">        * data (3D array): any of the filled band data</span>
<span class="sd">        * mytime (vector): Days of data in 3D arrays</span>
<span class="sd">        * lat (vector): Latitudes</span>
<span class="sd">        * lon (vector): Latitudes</span>
<span class="sd">        * mask (2D array): Land mask</span>
<span class="sd">        * var (int): number indicating the type of data in &quot;data&quot;</span>
<span class="sd">        * dineofWorkDir (str): Output directory</span>

<span class="sd">    **Returns:**</span>
<span class="sd">        none</span>

<span class="sd">    **Outputs**</span>
<span class="sd">        NetCDF3 file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">netCDF4</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="k">print</span> <span class="s2">&quot; in netcdfwrite&quot;</span>
    <span class="k">print</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># myz=[i for i, x in enumerate(mysequence) if x == 0]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">mytime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">noz</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sst&#39;</span><span class="p">)</span>  <span class="c1"># var 0</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;chla&#39;</span><span class="p">)</span>  <span class="c1"># var 1</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r412&#39;</span><span class="p">)</span>  <span class="c1"># var 2</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r443&#39;</span><span class="p">)</span>  <span class="c1"># var 3</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r488&#39;</span><span class="p">)</span>  <span class="c1"># var 4</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r531&#39;</span><span class="p">)</span>  <span class="c1"># var 5</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r555&#39;</span><span class="p">)</span>  <span class="c1"># var 6</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fchla&#39;</span><span class="p">)</span>  <span class="c1"># var 7</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;f488&#39;</span><span class="p">)</span>  <span class="c1"># var 8</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;f555&#39;</span><span class="p">)</span>  <span class="c1"># var 9</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">32767.0</span>
    <span class="c1"># maybe replace upper two lines with ma plus fill</span>
    <span class="c1">#</span>
    <span class="k">print</span> <span class="n">names</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="k">print</span> <span class="s1">&#39;*****************************&#39;</span>

    <span class="n">ncfile</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dineofWorkDir</span><span class="p">,</span> <span class="s2">&quot;my&quot;</span><span class="o">+</span><span class="n">names</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">+</span>
                             <span class="s2">&quot;netcdfTest.nc&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;NETCDF3_CLASSIC&#39;</span><span class="p">)</span>
    <span class="c1"># create dimensions</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;timesst&#39;</span><span class="p">,</span> <span class="n">noz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># create variables</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
    <span class="c1"># sequence = ncfile.createVariable(&#39;sequence&#39;, &#39;f4&#39;, (&#39;time&#39;, ))</span>

    <span class="n">time</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;days since 0001-01-01 00:00:00.0&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="s1">&#39;gregorian&#39;</span>
    <span class="n">time</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">mytime</span>
    <span class="c1"># sequence[:]=mysequence</span>
    <span class="n">latitude</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">lat</span>
    <span class="n">longitude</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">lon</span>
    <span class="k">print</span> <span class="s1">&#39;first mytime&#39;</span><span class="p">,</span> <span class="n">mytime</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">sst</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;sst&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                    <span class="n">fill_value</span><span class="o">=-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="n">sst_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;sst_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="c1"># meansst = ncfile.createVariable(&#39;meansst&#39;, &#39;f4&#39;, (&#39;lat&#39;, &#39;lon&#39;, ))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Sea Surface Temperature&#39;</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">,</span> <span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">)</span>
        <span class="n">sst</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
        <span class="n">sst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">sst_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="c1"># meansst[:, :] = mean</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">chla</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;chla&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                     <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.0</span><span class="p">)</span>
        <span class="n">chla_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;chla_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">chla</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="mf">9999.0</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">chla</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Chlorophyll_a&#39;</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">chla</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">,</span> <span class="s1">&#39;sea_water_chlorophyll_a&#39;</span><span class="p">)</span>
        <span class="n">chla</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">chla_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="c1"># meanchla[:, :] = mean</span>
        <span class="k">print</span> <span class="s2">&quot;first data&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">r412</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r412&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                     <span class="n">fill_value</span><span class="o">=-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="n">r412_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r412_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r412</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r412</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Reflectance at 412nm&#39;</span><span class="p">)</span>
        <span class="n">r412</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">r412_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">r443</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r443&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                     <span class="n">fill_value</span><span class="o">=-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="n">r443_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r443_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r443</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r443</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Reflectance at 443nm&#39;</span><span class="p">)</span>
        <span class="n">r443</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">r443_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">r488</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r488&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                     <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.0</span><span class="p">)</span>
        <span class="n">r488_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r488_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r488</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="mf">9999.0</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r488</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Reflectance at 488nm&#39;</span><span class="p">)</span>
        <span class="n">r488</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">r488_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">r531</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r531&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                     <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.0</span><span class="p">)</span>
        <span class="n">r531_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r531_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r531</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">32767.0</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r531</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Reflectance at 531nm&#39;</span><span class="p">)</span>
        <span class="n">r531</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">r531_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">r555</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r555&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                     <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.0</span><span class="p">)</span>
        <span class="n">r555_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r555_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r555</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="mf">9999.0</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">r555</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Reflectance at 555nm&#39;</span><span class="p">)</span>
        <span class="n">r555</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">r555_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">fchla</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;fchla&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                      <span class="n">fill_value</span><span class="o">=-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="n">fchla_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;fchla_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                           <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">fchla</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">fchla</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Chlorophyll advection&#39;</span><span class="p">)</span>
        <span class="n">fchla</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">fchla_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">f488</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;f488&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                     <span class="n">fill_value</span><span class="o">=-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="n">f488_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;f488_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">f488</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">f488</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Advected reflectance at 488nm&#39;</span><span class="p">)</span>
        <span class="n">f488</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">f488_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">f555</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;f555&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                     <span class="n">fill_value</span><span class="o">=-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="n">f555_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;f555_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">f555</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">f555</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Advected reflectance at 555nm&#39;</span><span class="p">)</span>
        <span class="n">f555</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="n">f555_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;exiting netcdfwrite&quot;</span>
    <span class="k">return</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">write_filled_nc</span><span class="p">(</span><span class="n">chldata</span><span class="p">,</span> <span class="n">f488data</span><span class="p">,</span> <span class="n">f555data</span><span class="p">,</span> <span class="n">mytime</span><span class="p">,</span>
                    <span class="n">mylat</span><span class="p">,</span> <span class="n">mylon</span><span class="p">,</span> <span class="n">mymask</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**File writing function**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        The function writes the final netCDF file that will be passed</span>
<span class="sd">        to S4 for processing.</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        write_filled_nc(chldata, f488data, f555data, mytime, mylat, mylon,</span>
<span class="sd">                        mymask, dineofWorkDir):</span>

<span class="sd">    **Args:**</span>
<span class="sd">        * chldata (3D array)</span>
<span class="sd">        * f488data (3D array)</span>
<span class="sd">        * f555data (3D array)</span>
<span class="sd">        * mytime (vector): Days of data in 3D arrays</span>
<span class="sd">        * mylat (vector): Latitudes</span>
<span class="sd">        * mylon (vector): Latitudes</span>
<span class="sd">        * mymask (2D array): Land mask</span>
<span class="sd">        * dineofWorkDir (str): Output directory</span>

<span class="sd">    **Returns:**</span>
<span class="sd">        none</span>

<span class="sd">    **Outputs**</span>
<span class="sd">        NetCDF4 file</span>

<span class="sd">    **Output variables**</span>
<span class="sd">        * chla_filled (latitude, longitude, time)</span>
<span class="sd">        * r488_filled (latitude, longitude, time)</span>
<span class="sd">        * r555_filled (latitude, longitude, time)</span>
<span class="sd">        * mask (latitude, longitude)</span>
<span class="sd">        * latitude</span>
<span class="sd">        * longitude</span>
<span class="sd">        * time</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">netCDF4</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

    <span class="k">print</span> <span class="s1">&#39;Enter write_filled_nc&#39;</span>
    <span class="c1"># pull data into np arrays</span>
    <span class="n">chldata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">chldata</span><span class="p">)</span>
    <span class="n">f488data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f488data</span><span class="p">)</span>
    <span class="n">f555data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f555data</span><span class="p">)</span>
    <span class="n">mytime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>

    <span class="n">proc_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sst&#39;</span><span class="p">)</span>  <span class="c1"># var 0</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;chla&#39;</span><span class="p">)</span>  <span class="c1"># var 1</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r412&#39;</span><span class="p">)</span>  <span class="c1"># var 2</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r443&#39;</span><span class="p">)</span>  <span class="c1"># var 3</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r488&#39;</span><span class="p">)</span>  <span class="c1"># var 4</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r531&#39;</span><span class="p">)</span>  <span class="c1"># var 5</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r555&#39;</span><span class="p">)</span>  <span class="c1"># var 6</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fchla&#39;</span><span class="p">)</span>  <span class="c1"># var 7</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;f488&#39;</span><span class="p">)</span>  <span class="c1"># var 8</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;f555&#39;</span><span class="p">)</span>  <span class="c1"># var 9</span>

    <span class="c1"># fill NaN values</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">chldata</span><span class="p">)</span>
    <span class="n">chldata</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">32767.0</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f488data</span><span class="p">)</span>
    <span class="n">f488data</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">32767.0</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f555data</span><span class="p">)</span>
    <span class="n">f555data</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">32767.0</span>

    <span class="n">last_day</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">mytime</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>
    <span class="n">str_sep</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="n">date_str</span> <span class="o">=</span> <span class="n">str_sep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="s1">&#39;habs_satellite_filled_&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">last_day</span><span class="o">.</span><span class="n">year</span><span class="p">),</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">last_day</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">last_day</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;.nc&#39;</span><span class="p">))</span>

    <span class="n">history_dates</span> <span class="o">=</span> <span class="p">[</span><span class="n">str_sep</span><span class="o">.</span><span class="n">join</span><span class="p">((</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xtime</span><span class="p">))</span><span class="o">.</span><span class="n">year</span><span class="p">),</span>
                     <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xtime</span><span class="p">))</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                     <span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">xtime</span><span class="p">))</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
                     <span class="k">for</span> <span class="n">xtime</span> <span class="ow">in</span> <span class="n">mytime</span><span class="p">]</span>

    <span class="c1"># open netcdf file for writing</span>
    <span class="n">ncfile</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dineofWorkDir</span><span class="p">,</span> <span class="n">date_str</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span>
                             <span class="n">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4&#39;</span><span class="p">)</span>

    <span class="c1"># create dimensions</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="n">mylat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="n">mylon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># create coodinate variables and attributes</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;days since 0001-01-01 00:00:00.0&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="s1">&#39;gregorian&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;time&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">_CoordinateAxisType</span> <span class="o">=</span> <span class="s1">&#39;Time&#39;</span>

    <span class="n">latitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">latitude</span><span class="o">.</span><span class="n">_CoordinateAxisType</span> <span class="o">=</span> <span class="s1">&#39;Lat&#39;</span>
    <span class="n">latitude</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="s1">&#39;31.30, 43.00&#39;</span>
    <span class="n">latitude</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;latitude&#39;</span>
    <span class="n">latitude</span><span class="o">.</span><span class="n">point_spacing</span> <span class="o">=</span> <span class="s1">&#39;even&#39;</span>
    <span class="n">latitude</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_north&#39;</span>
    <span class="n">latitude</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="s1">&#39;Y&#39;</span>
    <span class="n">latitude</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Latitude&#39;</span>

    <span class="n">longitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">longitude</span><span class="o">.</span><span class="n">_CoordinateAxisType</span> <span class="o">=</span> <span class="s1">&#39;Lon&#39;</span>
    <span class="n">longitude</span><span class="o">.</span><span class="n">actual_range</span> <span class="o">=</span> <span class="s1">&#39;232.50, 243.00&#39;</span>
    <span class="n">longitude</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;longitude&#39;</span>
    <span class="n">longitude</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Longitude&#39;</span>
    <span class="n">longitude</span><span class="o">.</span><span class="n">point_spacing</span> <span class="o">=</span> <span class="s1">&#39;even&#39;</span>
    <span class="n">longitude</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;degrees_east&#39;</span>
    <span class="n">longitude</span><span class="o">.</span><span class="n">axis</span> <span class="o">=</span> <span class="s1">&#39;X&#39;</span>

    <span class="c1"># fill  coodinate variables with data</span>
    <span class="n">time</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">mytime</span>
    <span class="n">latitude</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">mylat</span>
    <span class="n">longitude</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">mylon</span>

    <span class="c1"># global attributes</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">product_name</span> <span class="o">=</span> <span class="n">date_str</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;EOF filled MODIS chlorophyll_a, 488nm reflectance, and &quot;</span> \
                   <span class="s2">&quot;555nm reflectance fields at 3 km resolution for the &quot;</span>\
                   <span class="s2">&quot;California and Southern Oregon coast&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">source_data</span> <span class="o">=</span> <span class="s2">&quot;Satellite observations, MODIS Aqua ocean color &quot;</span>\
                         <span class="s2">&quot;L2 LAC data&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">instrument</span> <span class="o">=</span> <span class="s2">&quot;MODIS&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">platform</span> <span class="o">=</span> <span class="s2">&quot;Aqua&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="s2">&quot;Oceans &gt; Ocean Chemistry &gt; Chlorophyll; Oceans &gt; &quot;</span>\
                      <span class="s2">&quot;Ocean Optics &gt; Ocean Color; Oceans &gt; Ocean Optics &gt; &quot;</span>\
                      <span class="s2">&quot;Reflectance&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">keywords_vocabulary</span> <span class="o">=</span> <span class="s2">&quot;NASA Global Change Master Directory (GCMD) &quot;</span>\
                                 <span class="s2">&quot;Science Keywords&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">institution</span> <span class="o">=</span> <span class="s2">&quot;CoastWatch-West Coast and NOAA/NMFS/SWFSC/ERD&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">creator_url</span> <span class="o">=</span> <span class="s2">&quot;http://coastwatch.pfeg.noaa.gov&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">contact</span> <span class="o">=</span> <span class="s2">&quot;http://www.pfeg.noaa.gov/guest_book.html&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">creator_name</span> <span class="o">=</span> <span class="s2">&quot;erd.data&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">creator_email</span> <span class="o">=</span> <span class="s2">&quot;http://www.pfeg.noaa.gov/guest_book.html&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">publisher_name</span> <span class="o">=</span> <span class="s2">&quot;erd.data&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">publisher_email</span> <span class="o">=</span> <span class="s2">&quot;http://www.pfeg.noaa.gov/guest_book.html&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">cdm_data_type</span> <span class="o">=</span> <span class="s2">&quot;grid&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">summary</span> <span class="o">=</span> <span class="s2">&quot;MODIS Aqua 1 km ocean color LAC data are binned into &quot;</span>\
                     <span class="s2">&quot;1-day composites and the chlorophyll_a plus the 488nm &quot;</span>\
                     <span class="s2">&quot;and 555nm reflectance bands are extracted. The most &quot;</span>\
                     <span class="s2">&quot;recent day&#39;s data plus the prior 180 days of data are &quot;</span>\
                     <span class="s2">&quot;collected for each band and saved to a netCDF3 file &quot;</span>\
                     <span class="s2">&quot;along with a land mask. DINEOF routines are run using &quot;</span>\
                     <span class="s2">&quot;the netCDF3 file as the source data to generate gap-&quot;</span>\
                     <span class="s2">&quot;free data field for all 3 three bands. The gap-free &quot;</span>\
                     <span class="s2">&quot;fields are down-sampled to the 3.0 km resolution of &quot;</span>\
                     <span class="s2">&quot;the ROMS model and saved in this newCDF4 file, along &quot;</span>\
                     <span class="s2">&quot;with a land mask.&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">proc_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span> <span class="o">+</span>\
                     <span class="s2">&quot;: nowcast_control.py and &quot;</span>\
                     <span class="s2">&quot;filled_satellite_data.py processing scripts plus DINEOF&quot;</span>\
                     <span class="s2">&quot; ver 3.0. Data extending back 180 from today</span><span class="se">\&#39;</span><span class="s2">s &quot;</span>\
                     <span class="s2">&quot;including these dates: &quot;</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">history_dates</span><span class="p">)</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">spatial_resolution</span> <span class="o">=</span> <span class="s2">&quot;0.03 degree&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">Southernmost_Northing</span> <span class="o">=</span> <span class="mf">31.30</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">Northernmost_Northing</span> <span class="o">=</span> <span class="mf">43.00</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">Westernmost_Easting</span> <span class="o">=</span> <span class="mf">232.50</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">Easternmost_Easting</span> <span class="o">=</span> <span class="mf">243.00</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">creation_date</span> <span class="o">=</span> <span class="n">proc_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">processing_level</span> <span class="o">=</span> <span class="s2">&quot;L3 Mapped&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">standard_name_vocabulary</span> <span class="o">=</span> <span class="s2">&quot;NetCDF Climate and Forecast (CF) &quot;</span>\
                                      <span class="s2">&quot;Metadata Convention&quot;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">Conventions</span> <span class="o">=</span> <span class="s1">&#39;CF-1.6, COARDS, ACDD-1.3&#39;</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">license</span> <span class="o">=</span> <span class="s1">&#39;The data may be used and redistributed for free but &#39;</span>\
                     <span class="s1">&#39;is not intended for legal use, since it may contain &#39;</span>\
                     <span class="s1">&#39;inaccuracies. Neither the data Contributor, CoastWatch,&#39;</span>\
                     <span class="s1">&#39; NOAA, nor the United States Government, nor any of &#39;</span>\
                     <span class="s1">&#39;their employees or contractors, makes any warranty, &#39;</span>\
                     <span class="s1">&#39;express or implied, including warranties of &#39;</span>\
                     <span class="s1">&#39;merchantability and fitness for a particular purpose, &#39;</span>\
                     <span class="s1">&#39;or assumes any legal liability for the accuracy, &#39;</span>\
                     <span class="s1">&#39;completeness, or usefulness, of this information.&#39;</span>

    <span class="k">print</span> <span class="s1">&#39;first mytime&#39;</span><span class="p">,</span> <span class="n">mytime</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>

    <span class="c1"># create data variables and attributes, then fill variables with data</span>
    <span class="n">chla_filled</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;chla_filled&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="p">),</span>
                                        <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">chla_filled</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="mf">9999.</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">chla_filled</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Chlorophyll fields filled with EOF&#39;</span><span class="p">)</span>
    <span class="n">chla_filled</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;mg m^-3&#39;</span>
    <span class="n">chla_filled</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">chldata</span>

    <span class="n">r488_filled</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r488_filled&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="p">),</span>
                                        <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.</span><span class="p">)</span>
    <span class="n">r488_filled</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Remote sensing reflectance at 488 nm&#39;</span>
    <span class="n">r488_filled</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;surface_ratio_of_upwelling_radiance_&#39;</span>\
                                <span class="s1">&#39;emerging_from_sea_water_to_downwelling_&#39;</span>\
                                <span class="s1">&#39;radiative_flux_in_air&#39;</span>
    <span class="n">r488_filled</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;sr^-1&#39;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">r488_filled</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="mf">9999.</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">r488_filled</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;488nm reflectance fields filled with EOF&#39;</span><span class="p">)</span>
    <span class="n">r488_filled</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">f488data</span>

    <span class="n">r555_filled</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r555_filled&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="p">),</span>
                                        <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.</span><span class="p">)</span>
    <span class="n">r555_filled</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s1">&#39;Remote sensing reflectance at 555 nm&#39;</span>
    <span class="n">r555_filled</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s1">&#39;surface_ratio_of_upwelling_radiance_&#39;</span>\
                                <span class="s1">&#39;emerging_from_sea_water_to_downwelling_&#39;</span>\
                                <span class="s1">&#39;radiative_flux_in_air&#39;</span>
    <span class="n">r555_filled</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;sr^-1&#39;</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">r555_filled</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="mf">9999.</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">r555_filled</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span>
            <span class="s1">&#39;555nm reflectance fields filled with EOF&#39;</span><span class="p">)</span>
    <span class="n">r555_filled</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">f555data</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="p">))</span>
    <span class="n">mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mymask</span>
    <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;exiting write_filled_nc&quot;</span>
    <span class="k">return</span> <span class="n">date_str</span>


<span class="k">def</span> <span class="nf">get_bands_4</span><span class="p">(</span><span class="n">model_lat</span><span class="p">,</span> <span class="n">model_lon</span><span class="p">,</span> <span class="n">modelmask</span><span class="p">,</span> <span class="n">dataDir</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**Function to aggregates satellite data**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        The function aggregates L3 chl, r488 and r555 band data from now and</span>
<span class="sd">        back 180 days into a single netCDF3 file along with a land mask.</span>
<span class="sd">        It handles newer netCDF and  older hdf input files.</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        get_bands_4(model_lat, model_lon, modelmask, dataDir, dineofWorkDir, now)</span>

<span class="sd">    **Args:**</span>
<span class="sd">        * model_lat (vector): Lats from the ROMS model</span>
<span class="sd">        * model_lon (vector): Lons from the ROMS model</span>
<span class="sd">        * modelmask (array): Land mask from the ROMS model</span>
<span class="sd">        * dataDir (str): Dir where L# band files are stored</span>
<span class="sd">        * dineofWorkDir(str): Output directory</span>
<span class="sd">        * now (date object):</span>

<span class="sd">    **Returns:**</span>
<span class="sd">        bool: True if successful</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">netCDF4</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="kn">from</span> <span class="nn">habs_lib_prenowcast</span> <span class="kn">import</span> <span class="n">getfilelist</span>
    <span class="kn">from</span> <span class="nn">habs_lib_prenowcast</span> <span class="kn">import</span> <span class="n">generalncwrite2</span>
    <span class="kn">from</span> <span class="nn">habs_lib_prenowcast</span> <span class="kn">import</span> <span class="n">genmask</span>
    <span class="kn">from</span> <span class="nn">habs_lib_prenowcast</span> <span class="kn">import</span> <span class="n">meanVar</span>

    <span class="k">print</span> <span class="s1">&#39;START get_bands_4&#39;</span>
    <span class="p">[</span><span class="n">myfiles488</span><span class="p">,</span> <span class="n">myfiles555</span><span class="p">,</span> <span class="n">myfileschl</span><span class="p">,</span>
     <span class="n">seq488</span><span class="p">,</span> <span class="n">seq555</span><span class="p">,</span> <span class="n">seqchl</span><span class="p">]</span> <span class="o">=</span> <span class="n">getfilelist</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">now</span><span class="p">)</span>
    <span class="n">icount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">btimes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># iapp is set to &#39;0&#39; to open netCDF to write for the first 50 files.</span>
    <span class="c1"># For each set of 50 after the first, the file opens to append</span>
    <span class="n">iapp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">myfiles488</span><span class="p">:</span>
        <span class="c1"># for i in myfiles:</span>
        <span class="c1"># need time from file name</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">yday</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">7</span><span class="p">]</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">yday</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:])</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="n">year</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>

        <span class="n">myordtime</span> <span class="o">=</span> <span class="n">offset</span><span class="o">+</span><span class="n">yday</span>
        <span class="k">print</span> <span class="n">myordtime</span><span class="p">,</span> <span class="n">yday</span><span class="p">,</span> <span class="n">i</span>
        <span class="c1"># Let&#39;s try to limit this to 50 files at a time</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">11</span><span class="p">:</span>  <span class="c1"># this indentifies the hdf files</span>
            <span class="k">print</span> <span class="s1">&#39;len(i) == 11:&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Start &#39;</span>
                <span class="n">fhandle</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">sumch</span> <span class="o">=</span> <span class="n">fhandle</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;chlor_a_mean&#39;</span><span class="p">][:,</span> <span class="p">:]</span>
                <span class="n">sum488</span> <span class="o">=</span> <span class="n">fhandle</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Rrs_488_mean&#39;</span><span class="p">][:,</span> <span class="p">:]</span>
                <span class="n">sum555</span> <span class="o">=</span> <span class="n">fhandle</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Rrs_555_mean&#39;</span><span class="p">][:,</span> <span class="p">:]</span>
                <span class="n">sumch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sumch</span><span class="p">)</span>
                <span class="n">sum488</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sum488</span><span class="p">)</span>
                <span class="n">sum555</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sum555</span><span class="p">)</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">fhandle</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:]</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">fhandle</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:]</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">+</span><span class="mi">360</span>
                <span class="n">newchla</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sumch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">newr488</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sum488</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">newr555</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sum555</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">icount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">btimes</span> <span class="o">=</span> <span class="p">[</span><span class="n">myordtime</span><span class="p">]</span>
                    <span class="n">chlarray</span> <span class="o">=</span> <span class="n">newchla</span>
                    <span class="n">r488array</span> <span class="o">=</span> <span class="n">newr488</span>
                    <span class="n">r555array</span> <span class="o">=</span> <span class="n">newr555</span>
                    <span class="c1"># MEAN FOM MEAN VAR ***********************************</span>
                    <span class="n">size1</span><span class="p">,</span> <span class="n">size2</span> <span class="o">=</span> <span class="n">newchla</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size1</span><span class="p">,</span> <span class="n">size2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s1">&#39;empty (zeros) mean array made&#39;</span>
                    <span class="n">no</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size1</span><span class="p">,</span> <span class="n">size2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s1">&#39;num array made&#39;</span>
                    <span class="c1"># *****************************************************</span>
                    <span class="k">print</span> <span class="n">icount</span>
                    <span class="n">icount</span> <span class="o">=</span> <span class="n">icount</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">btimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myordtime</span><span class="p">)</span>
                    <span class="n">chlarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">chlarray</span><span class="p">,</span> <span class="n">newchla</span><span class="p">))</span>
                    <span class="n">r488array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r488array</span><span class="p">,</span> <span class="n">newr488</span><span class="p">))</span>
                    <span class="n">r555array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r555array</span><span class="p">,</span> <span class="n">newr555</span><span class="p">))</span>
                    <span class="n">icount</span> <span class="o">=</span> <span class="n">icount</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">print</span> <span class="n">icount</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Oops 1 &quot;</span><span class="p">,</span> <span class="n">i</span>
                <span class="k">return</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span> <span class="s1">&#39;Start try loop&#39;</span>
                <span class="k">print</span> <span class="s2">&quot;OK&quot;</span>
                <span class="n">fhandle1</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span>
                                           <span class="s1">&#39;A&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_chlora.nc&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">print</span> <span class="s2">&quot;netcdf _chlora is open to read&quot;</span>
                <span class="n">fhandle2</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span>
                                           <span class="s1">&#39;A&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_488.nc&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">print</span> <span class="s2">&quot;netcdf _488 is open to read&quot;</span>
                <span class="n">fhandle3</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span>
                                           <span class="s1">&#39;A&#39;</span><span class="o">+</span><span class="n">num</span><span class="o">+</span><span class="s1">&#39;_555.nc&#39;</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="k">print</span> <span class="s2">&quot;netcdf _555 is open to read&quot;</span>
                <span class="n">sumch</span> <span class="o">=</span> <span class="n">fhandle1</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;chlor_a&#39;</span><span class="p">][:,</span> <span class="p">:]</span>
                <span class="n">fillValue</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">sumch</span><span class="p">,</span> <span class="s1">&#39;fill_value&#39;</span><span class="p">)</span>
                <span class="k">print</span> <span class="s1">&#39;fill values&#39;</span><span class="p">,</span> <span class="n">fillValue</span>
                <span class="n">sum488</span> <span class="o">=</span> <span class="n">fhandle2</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Rrs_488&#39;</span><span class="p">][:,</span> <span class="p">:]</span>
                <span class="k">print</span> <span class="s1">&#39;fill values488&#39;</span>
                <span class="n">sum555</span> <span class="o">=</span> <span class="n">fhandle3</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;Rrs_555&#39;</span><span class="p">][:,</span> <span class="p">:]</span>
                <span class="k">print</span> <span class="s1">&#39;fill values555&#39;</span>
                <span class="n">sumch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sumch</span><span class="p">)</span>
                <span class="n">sum488</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sum488</span><span class="p">)</span>
                <span class="n">sum555</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">sum555</span><span class="p">)</span>
                <span class="k">print</span> <span class="s1">&#39;np made&#39;</span>
                <span class="k">print</span> <span class="s1">&#39;shapes&#39;</span><span class="p">,</span> <span class="n">sumch</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sum488</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">sum555</span><span class="o">.</span><span class="n">shape</span>
                <span class="c1"># ll = sumch &lt;=  0 # was ll = sumch &lt; 0</span>
                <span class="c1"># sumch[ll] = &#39;NaN&#39;</span>
                <span class="c1"># ll = sumch &gt; 100 # new to limit chl</span>
                <span class="c1"># sumch[ll] = &#39;NaN&#39; # new to limit chl</span>
                <span class="c1"># ll = sum555 &lt; 0</span>
                <span class="c1"># sum555[ll] = &#39;NaN&#39;</span>
                <span class="c1"># ll = sum488 &lt; 0</span>
                <span class="c1"># sum488[ll] = &#39;NaN&#39;</span>

                <span class="n">sumch</span><span class="p">[</span><span class="n">sumch</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>  <span class="c1"># new to allow log conversion</span>
                <span class="n">sumch</span><span class="p">[</span><span class="n">sumch</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>  <span class="c1"># new to limit chl</span>
                <span class="n">sum555</span><span class="p">[</span><span class="n">sum555</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>
                <span class="n">sum488</span><span class="p">[</span><span class="n">sum488</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;NaN&#39;</span>

                <span class="k">print</span> <span class="s1">&#39;remove zeros&#39;</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">fhandle1</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lon&#39;</span><span class="p">][:]</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">fhandle1</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">][:]</span>
                <span class="n">inc</span> <span class="o">=</span> <span class="mf">1.1595781</span><span class="o">/</span><span class="mf">111.3</span>
                <span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">43</span><span class="p">,</span> <span class="mf">31.3</span><span class="p">,</span> <span class="o">-</span><span class="n">inc</span><span class="p">)</span>
                <span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">+</span><span class="mi">360</span>
                <span class="n">newchla</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sumch</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">newr488</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sum488</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">newr555</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">sum555</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">icount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">print</span> <span class="s1">&#39;start icount = 0&#39;</span>
                    <span class="n">btimes</span> <span class="o">=</span> <span class="p">[</span><span class="n">myordtime</span><span class="p">]</span>
                    <span class="n">chlarray</span> <span class="o">=</span> <span class="n">newchla</span>
                    <span class="n">r488array</span> <span class="o">=</span> <span class="n">newr488</span>
                    <span class="n">r555array</span> <span class="o">=</span> <span class="n">newr555</span>
                    <span class="c1"># MEAN FROM MEAN VAR ***********************************</span>
                    <span class="n">size1</span><span class="p">,</span> <span class="n">size2</span> <span class="o">=</span> <span class="n">newchla</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size1</span><span class="p">,</span> <span class="n">size2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s1">&#39;empty (zeros) mean array made&#39;</span>
                    <span class="n">no</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">size1</span><span class="p">,</span> <span class="n">size2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s1">&#39;num array made&#39;</span>
                    <span class="c1"># *****************************************************</span>
                    <span class="k">print</span> <span class="s1">&#39;if&#39;</span><span class="p">,</span> <span class="n">icount</span>
                    <span class="n">icount</span> <span class="o">=</span> <span class="n">icount</span><span class="o">+</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">btimes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myordtime</span><span class="p">)</span>
                    <span class="k">print</span> <span class="n">myordtime</span>
                    <span class="n">chlarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">chlarray</span><span class="p">,</span> <span class="n">newchla</span><span class="p">))</span>
                    <span class="n">r488array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r488array</span><span class="p">,</span> <span class="n">newr488</span><span class="p">))</span>
                    <span class="n">r555array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">r555array</span><span class="p">,</span> <span class="n">newr555</span><span class="p">))</span>
                    <span class="n">icount</span> <span class="o">=</span> <span class="n">icount</span><span class="o">+</span><span class="mi">1</span>
                    <span class="k">print</span> <span class="s1">&#39;else&#39;</span><span class="p">,</span> <span class="n">icount</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">print</span> <span class="s2">&quot;Oops 2 &quot;</span><span class="p">,</span> <span class="n">i</span>
                <span class="k">return</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">print</span> <span class="s1">&#39;fill value is &#39;</span><span class="p">,</span> <span class="n">fillValue</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">newchla</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">masked_invalid</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
        <span class="c1"># obs[ll] = fillValue</span>
        <span class="c1"># ma.filled(mx, fill_value = fillValue)</span>
        <span class="c1"># obs = ma.masked_values(obs, fillValue)</span>

        <span class="c1"># mean varience method to generate mean array</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">no</span> <span class="o">=</span> <span class="n">meanVar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">no</span><span class="p">,</span> <span class="n">obs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">icount</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">:</span>
            <span class="c1"># Write to NetCDF for dineof to work</span>
            <span class="k">print</span> <span class="s1">&#39;writing to netcdf...&#39;</span>
            <span class="n">slat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">slon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">mylon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">slon</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="n">mylat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">slat</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="c1"># need to create mask</span>
            <span class="n">themask</span> <span class="o">=</span> <span class="n">genmask</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">model_lon</span><span class="p">,</span> <span class="n">model_lat</span><span class="p">,</span> <span class="n">modelmask</span><span class="p">)</span>
            <span class="n">themask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">themask</span><span class="p">)</span>
            <span class="c1"># create blank mean</span>
            <span class="k">print</span> <span class="s1">&#39;chl array &lt;50&#39;</span><span class="p">,</span> <span class="n">chlarray</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">band_time</span> <span class="o">=</span> <span class="n">btimes</span>
            <span class="k">print</span> <span class="s2">&quot;write .nc files&quot;</span>
            <span class="k">print</span> <span class="p">(</span><span class="s2">&quot;array shapes&quot;</span><span class="p">,</span> <span class="n">chlarray</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">r488array</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                   <span class="n">r555array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">print</span> <span class="s1">&#39;FOR LOG&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">chlarray</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">chlarray</span><span class="p">)</span>
            <span class="n">chlarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">chlarray</span><span class="p">)</span>  <span class="c1"># added to get normal dist</span>
            <span class="k">print</span> <span class="s1">&#39;FOR LOG2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">chlarray</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">chlarray</span><span class="p">)</span>
            <span class="n">generalncwrite2</span><span class="p">(</span><span class="n">chlarray</span><span class="p">,</span> <span class="n">band_time</span><span class="p">,</span> <span class="n">mylat</span><span class="p">,</span> <span class="n">mylon</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span>
                            <span class="n">themask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iapp</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">)</span>
            <span class="n">generalncwrite2</span><span class="p">(</span><span class="n">r488array</span><span class="p">,</span> <span class="n">band_time</span><span class="p">,</span> <span class="n">mylat</span><span class="p">,</span> <span class="n">mylon</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span>
                            <span class="n">themask</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">iapp</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">)</span>
            <span class="n">generalncwrite2</span><span class="p">(</span><span class="n">r555array</span><span class="p">,</span> <span class="n">band_time</span><span class="p">,</span> <span class="n">mylat</span><span class="p">,</span> <span class="n">mylon</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span>
                            <span class="n">themask</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">iapp</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">)</span>
            <span class="n">icount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Set netCDF to append after the first 50 files are processed</span>
            <span class="n">iapp</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># end of if icount</span>
    <span class="c1"># end of for loop i</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">icount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">icount</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)):</span>
        <span class="k">print</span> <span class="s1">&#39;writing last of netcdf...&#39;</span>
        <span class="n">slat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">slon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">print</span> <span class="s1">&#39;slon&#39;</span><span class="p">,</span> <span class="n">slon</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span> <span class="s1">&#39;slat&#39;</span><span class="p">,</span> <span class="n">slat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mylon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">slon</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">mylat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">slat</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">print</span> <span class="s1">&#39;1st&#39;</span><span class="p">,</span> <span class="s1">&#39;mylon&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mylon</span><span class="p">),</span> <span class="s1">&#39;mylat&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mylat</span><span class="p">)</span>
        <span class="c1"># need to create mask</span>
        <span class="n">themask</span> <span class="o">=</span> <span class="n">genmask</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">model_lon</span><span class="p">,</span> <span class="n">model_lat</span><span class="p">,</span> <span class="n">modelmask</span><span class="p">)</span>
        <span class="n">themask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">themask</span><span class="p">)</span>

        <span class="k">print</span> <span class="s1">&#39;chl array &lt;50&#39;</span><span class="p">,</span> <span class="n">chlarray</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">band_time</span> <span class="o">=</span> <span class="n">btimes</span>
        <span class="c1"># write out data that was at the end</span>
        <span class="k">print</span> <span class="n">band_time</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">fill_value</span><span class="o">=-</span><span class="mf">999.</span><span class="p">)</span>
        <span class="k">print</span> <span class="s2">&quot;append .nc files&quot;</span>
        <span class="k">print</span> <span class="s1">&#39;FOR LOG&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">chlarray</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">chlarray</span><span class="p">)</span>
        <span class="n">chlarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">chlarray</span><span class="p">)</span>  <span class="c1"># added to get normal dist</span>
        <span class="k">print</span> <span class="s1">&#39;FOR LOG2&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">chlarray</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">chlarray</span><span class="p">)</span>
        <span class="n">generalncwrite2</span><span class="p">(</span><span class="n">chlarray</span><span class="p">,</span> <span class="n">band_time</span><span class="p">,</span> <span class="n">mylat</span><span class="p">,</span> <span class="n">mylon</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span>
                        <span class="n">themask</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">iapp</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">)</span>
        <span class="n">generalncwrite2</span><span class="p">(</span><span class="n">r488array</span><span class="p">,</span> <span class="n">band_time</span><span class="p">,</span> <span class="n">mylat</span><span class="p">,</span> <span class="n">mylon</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span>
                        <span class="n">themask</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">iapp</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">)</span>
        <span class="n">generalncwrite2</span><span class="p">(</span><span class="n">r555array</span><span class="p">,</span> <span class="n">band_time</span><span class="p">,</span> <span class="n">mylat</span><span class="p">,</span> <span class="n">mylon</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span>
                        <span class="n">themask</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">iapp</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">)</span>
    <span class="k">return</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">getfilelist</span><span class="p">(</span><span class="n">dataDir</span><span class="p">,</span> <span class="n">now</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**Function to list required files for processing**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        The function list L3 band files in the data dir and then filters</span>
<span class="sd">        on the file name to select files going back 180 days from &quot;now&quot;.</span>
<span class="sd">        Selected file names are sorted into separate arrays for r488nm,</span>
<span class="sd">        r555nm and chl. The arrays are returned to the calling function.</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        getfilelist(dataDir,now)</span>

<span class="sd">    **Args:**</span>
<span class="sd">        * dataDir (str): dir where L3 band files are stored</span>
<span class="sd">        * now (date object): date of most recent file</span>

<span class="sd">    **Changes:**</span>
<span class="sd">        This function eliminates returning the sequence info on the matrices.</span>
<span class="sd">        The sequence info is still generated in the function but are not used.</span>

<span class="sd">    **Returns:**</span>
<span class="sd">        * myfiles488: Array of 180 days of r488nm band L3 file names</span>
<span class="sd">        * myfiles555: Array of 180 days of r555nm band L3 file names</span>
<span class="sd">        * myfileschl: Array of 180 days of chlorophyll band L3 file names</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from yearback import myyearback</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">walk</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="k">print</span> <span class="s1">&#39;START getfile&#39;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># gets an array of file names</span>
    <span class="k">for</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">dataDir</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="n">mytoday</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">toordinal</span><span class="p">()</span>
    <span class="c1"># Set to number of days past to get</span>
    <span class="n">myoldday</span> <span class="o">=</span> <span class="n">mytoday</span><span class="o">-</span><span class="mi">180</span>
    <span class="c1"># myoldday = mytoday-51</span>
    <span class="n">filedates_to_get</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">myoldday</span><span class="p">,</span> <span class="n">mytoday</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">myfiles488</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">myfiles555</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">myfileschl</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seq488</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seq555</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">seqchl</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">filedates_to_get</span><span class="p">:</span>
        <span class="n">mytime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">fromordinal</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">year</span>
        <span class="n">yday</span> <span class="o">=</span> <span class="n">mytime</span><span class="o">.</span><span class="n">timetuple</span><span class="p">()</span><span class="o">.</span><span class="n">tm_yday</span>
        <span class="n">myfpre</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;</span><span class="si">%03d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">yday</span>

        <span class="c1"># Now we need to find if this is in the list f?</span>
        <span class="n">filetofind</span> <span class="o">=</span> <span class="n">myfpre</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span>
        <span class="n">filetofind488</span> <span class="o">=</span> <span class="n">myfpre</span><span class="o">+</span><span class="s1">&#39;_488.nc&#39;</span>
        <span class="n">filetofind555</span> <span class="o">=</span> <span class="n">myfpre</span><span class="o">+</span><span class="s1">&#39;_555.nc&#39;</span>
        <span class="n">filetofindchl</span> <span class="o">=</span> <span class="n">myfpre</span><span class="o">+</span><span class="s1">&#39;_chlora.nc&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">myindex</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filetofind</span><span class="p">)</span>
            <span class="c1"># myfiles.append(f[myindex])</span>
            <span class="n">myfiles488</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">myindex</span><span class="p">])</span>
            <span class="n">myfiles555</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">myindex</span><span class="p">])</span>
            <span class="n">myfileschl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">myindex</span><span class="p">])</span>
            <span class="c1"># seq.append(1)</span>
            <span class="n">seq488</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">seq555</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">seqchl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">myindex</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filetofind488</span><span class="p">)</span>
            <span class="n">myfiles488</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">myindex</span><span class="p">])</span>
            <span class="n">seq488</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">myindex</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filetofind555</span><span class="p">)</span>
            <span class="n">myfiles555</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">myindex</span><span class="p">])</span>
            <span class="n">seq555</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">myindex</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">filetofindchl</span><span class="p">)</span>
            <span class="n">myfileschl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="n">myindex</span><span class="p">])</span>
            <span class="n">seqchl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
<span class="c1">#            if len(seq)&gt; 0:</span>
<span class="c1">#                seq.append(0)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">myfiles488</span><span class="p">,</span> <span class="n">myfiles555</span><span class="p">,</span> <span class="n">myfileschl</span><span class="p">,</span> <span class="n">seq488</span><span class="p">,</span> <span class="n">seq555</span><span class="p">,</span> <span class="n">seqchl</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">genmask</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">model_lon</span><span class="p">,</span> <span class="n">model_lat</span><span class="p">,</span> <span class="n">modelmask</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**Function to generate a land mask**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        Creates the land mask for at MODIS full (1 km) resolution</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        genmask(lon, lat, model_lon, model_lat, modelmask)</span>

<span class="sd">    **Args:**</span>
<span class="sd">        * lon (1D array): longitude vector at full resoultion for MODIS</span>
<span class="sd">        * lat (1D array): latitude vector at full resoultion for MODIS</span>
<span class="sd">        * model_lon (1D array): longitude vector at ROMS resoultion</span>
<span class="sd">        * model_lat (1D array): latitude vector at ROMS resoultion</span>
<span class="sd">        * modelmask (2D array): land mask for the model data</span>

<span class="sd">    **Returns:**</span>
<span class="sd">        satmask: the land mask for at MODIS full (1 km) resolution</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="n">slon</span> <span class="o">=</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">slat</span> <span class="o">=</span> <span class="n">lat</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">slon</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">slat</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">satmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">slat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">slon</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">model_lon</span><span class="o">-</span><span class="n">lon</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">ilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dlon</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">y</span><span class="p">:</span>
            <span class="n">dlat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">model_lat</span><span class="o">-</span><span class="n">lat</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">ilat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dlat</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">modelmask</span><span class="p">[</span><span class="n">ilat</span><span class="p">,</span> <span class="n">ilon</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">satmask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">satmask</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">return</span><span class="p">(</span><span class="n">satmask</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">downsample</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xorig</span><span class="p">,</span> <span class="n">yorig</span><span class="p">,</span> <span class="n">xnew</span><span class="p">,</span> <span class="n">ynew</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**Function to downsample satellite data to a lower resolution**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        Downsample EOF data from Modis full resolution to ROMS resolution</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        downsample(data, xorig, yorig, xnew, ynew)</span>

<span class="sd">    **Args:**</span>
<span class="sd">        * data (3D array):</span>
<span class="sd">        * xorig (1D array): longitude vector at full MODIS resolution</span>
<span class="sd">        * yorig (1D array): latitude vector at full MODIS resolution</span>
<span class="sd">        * xnew (1D array): longitude vector at ROMS resolution</span>
<span class="sd">        * ynew (1D array): latitude vector at ROMS resolution</span>

<span class="sd">    **Returns:**</span>
<span class="sd">        newdata: the downsampled data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

    <span class="k">print</span> <span class="s2">&quot;In mydownsample&quot;</span>
    <span class="n">sdata</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">print</span> <span class="s2">&quot;filling array&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sdata</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">t</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span>
        <span class="n">interd</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">xorig</span><span class="p">,</span> <span class="n">yorig</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
        <span class="n">newd</span> <span class="o">=</span> <span class="n">interd</span><span class="p">(</span><span class="n">xnew</span><span class="p">,</span> <span class="n">ynew</span><span class="p">)</span>
        <span class="n">newd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">newd</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="n">newd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">newdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">newdata</span><span class="p">,</span> <span class="n">newd</span><span class="p">))</span>
    <span class="k">print</span> <span class="s2">&quot;Exit mydownsample&quot;</span>
    <span class="k">return</span> <span class="n">newdata</span>


<span class="k">def</span> <span class="nf">geteofdata</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">datDir</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**Function to load EOF data from a netCDF3 file into memory**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        Load data from first EOF data file</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        geteofdata(var, datDir)</span>

<span class="sd">    **Args:**</span>
<span class="sd">        * var (int): integer the indicates whcih var to load</span>
<span class="sd">        * datDir (str): directory where the EOF data files are stored</span>

<span class="sd">    **Returns:**</span>
<span class="sd">        * time (1D array): time for each lat lon 2D array in data</span>
<span class="sd">        * longitude (1D array): longitude vector</span>
<span class="sd">        * latitude (1D array): latitude vector</span>
<span class="sd">        * data (3D array): data array (time, latitude, longitude)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">netCDF4</span>
    <span class="kn">import</span> <span class="nn">os</span>

    <span class="k">print</span> <span class="s2">&quot;In geteofdata&quot;</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sst&#39;</span><span class="p">)</span>   <span class="c1"># var 0</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;chla&#39;</span><span class="p">)</span>  <span class="c1"># var 1</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r412&#39;</span><span class="p">)</span>  <span class="c1"># var 2</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r443&#39;</span><span class="p">)</span>  <span class="c1"># var 3</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r488&#39;</span><span class="p">)</span>  <span class="c1"># var 4</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r531&#39;</span><span class="p">)</span>  <span class="c1"># var 5</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r555&#39;</span><span class="p">)</span>  <span class="c1"># var 6</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fchla&#39;</span><span class="p">)</span>  <span class="c1"># var 7</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;f488&#39;</span><span class="p">)</span>  <span class="c1"># var 8</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;f555&#39;</span><span class="p">)</span>  <span class="c1"># var 9</span>
    <span class="k">print</span> <span class="s2">&quot;load EOF data&quot;</span>
    <span class="n">ncfile</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">datDir</span><span class="p">,</span> <span class="s1">&#39;my&#39;</span><span class="o">+</span><span class="n">names</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="o">+</span>
                             <span class="s1">&#39;netcdf.nc&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;NETCDF3_CLASSIC&#39;</span><span class="p">)</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">][:]</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][:]</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">][:]</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;sst_filled&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;chla_filled&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;r412_filled&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;r443_filled&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;r488_filled&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;r531_filled&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;r555_filled&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;fchla&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;f488&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;f555&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="k">print</span> <span class="s2">&quot;exiting geteofdata&quot;</span>
    <span class="k">return</span><span class="p">[</span><span class="n">time</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">data</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">generalncwrite2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mytime</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span>
                    <span class="n">iapp</span><span class="p">,</span> <span class="n">dineofWorkDir</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**File writing function**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        Write out netCDF file containing satellite data to feed to DINEOF.</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        generalncwrite2(data, mytime, lat, lon, mean, mask, var, iapp, dineofWorkDir)</span>

<span class="sd">    **Outputs**</span>
<span class="sd">        NetCDF3 file</span>

<span class="sd">    **Output variables**</span>
<span class="sd">        * chla (3D array): chlorophyll data (latitude, longitude, time):</span>
<span class="sd">        * r488 (3D array): rf488 nm  data  (latitude, longitude, time)</span>
<span class="sd">        * r555 (3D array): rf555 nm data  (latitude, longitude, time)</span>
<span class="sd">        * mask (2D array): land mask (latitude, longitude)</span>
<span class="sd">        * latitude (1D array)</span>
<span class="sd">        * longitude (1D array)</span>
<span class="sd">        * time (1D array)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">netCDF4</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="k">print</span> <span class="s1">&#39;*****************************&#39;</span>
    <span class="k">print</span> <span class="s2">&quot; in generalncwrite2&quot;</span>
    <span class="k">print</span> <span class="n">var</span><span class="p">,</span> <span class="n">iapp</span>
    <span class="k">print</span> <span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># myz = [i for i, x in enumerate(mysequence) if x == 0]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">mytime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="n">noz</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;sst&#39;</span><span class="p">)</span>  <span class="c1"># var 0</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;chla&#39;</span><span class="p">)</span>  <span class="c1"># var 1</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r412&#39;</span><span class="p">)</span>  <span class="c1"># var 2</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r443&#39;</span><span class="p">)</span>  <span class="c1"># var 3</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r488&#39;</span><span class="p">)</span>  <span class="c1"># var 4</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r531&#39;</span><span class="p">)</span>  <span class="c1"># var 5</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;r555&#39;</span><span class="p">)</span>  <span class="c1"># var 6</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;fchla&#39;</span><span class="p">)</span>  <span class="c1"># var 7</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;f488&#39;</span><span class="p">)</span>  <span class="c1"># var 8</span>
    <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;f555&#39;</span><span class="p">)</span>  <span class="c1"># var 9</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">data</span><span class="p">[</span><span class="n">ll</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">32767.0</span>
    <span class="c1"># maybe replace upper two lines with ma plus fill</span>

    <span class="k">print</span> <span class="n">names</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
    <span class="k">print</span> <span class="s1">&#39;*****************************&#39;</span>

<span class="c1"># Transpose all of the arrays</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">iapp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ncfile</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dineofWorkDir</span><span class="p">,</span> <span class="s2">&quot;my&quot;</span><span class="o">+</span><span class="n">names</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">+</span>
                                 <span class="s2">&quot;netcdf.nc&quot;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;NETCDF3_CLASSIC&#39;</span><span class="p">)</span>
        <span class="c1"># create dimensions</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ncfile</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;timesst&#39;</span><span class="p">,</span> <span class="n">noz</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># create variables</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;f8&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="n">longitude</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
        <span class="c1"># sequence = ncfile.createVariable(&#39;sequence&#39;, &#39;f4&#39;, (&#39;time&#39;, ))</span>

        <span class="n">time</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;days since 0001-01-01 00:00:00.0&#39;</span>
        <span class="n">time</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="s1">&#39;gregorian&#39;</span>
        <span class="n">time</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">mytime</span>
        <span class="n">latitude</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="n">longitude</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="k">print</span> <span class="s1">&#39;first mytime&#39;</span><span class="p">,</span> <span class="n">mytime</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ncfile</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dineofWorkDir</span><span class="p">,</span> <span class="s2">&quot;my&quot;</span><span class="o">+</span><span class="n">names</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">+</span>
                                 <span class="s2">&quot;netcdf.nc&quot;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="s1">&#39;NETCDF3_CLASSIC&#39;</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
        <span class="n">lt1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mytime</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;length&#39;</span><span class="p">,</span> <span class="n">lt1</span>
        <span class="c1"># time already has full dimensions so we need to do something else!</span>
        <span class="n">junk</span> <span class="o">=</span> <span class="n">time</span><span class="p">[:]</span>
        <span class="k">print</span> <span class="s1">&#39;junk&#39;</span><span class="p">,</span> <span class="n">junk</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">junk</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">junk</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">print</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">lt</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">print</span> <span class="n">lt</span>
        <span class="n">mystart</span> <span class="o">=</span> <span class="n">lt</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">mystop</span> <span class="o">=</span> <span class="n">mystart</span><span class="o">+</span><span class="n">lt1</span>
        <span class="n">mynums</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">mystart</span><span class="p">,</span> <span class="n">mystop</span><span class="p">)</span>
        <span class="n">time</span><span class="p">[</span><span class="n">mynums</span><span class="p">]</span> <span class="o">=</span> <span class="n">mytime</span>

    <span class="c1">#    pdb.set_trace()</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iapp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sst</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;sst&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                        <span class="n">fill_value</span><span class="o">=-</span><span class="mf">999.</span><span class="p">)</span>
            <span class="n">sst_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;sst_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                             <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">meansst</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;meansst&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Sea Surface Temperature&#39;</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">sst</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">,</span> <span class="s1">&#39;sea_water_temperature&#39;</span><span class="p">)</span>
            <span class="n">sst</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span>
            <span class="n">sst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">sst_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="n">meansst</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sst</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;sst&#39;</span><span class="p">]</span>
            <span class="n">meansst</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;meansst&#39;</span><span class="p">]</span>
            <span class="n">sst_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;sst_mask&#39;</span><span class="p">]</span>
            <span class="n">sst</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">meansst</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mean</span>
            <span class="n">sst_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iapp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chla</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;chla&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                         <span class="n">fill_value</span><span class="o">=-</span><span class="mf">32767.0</span><span class="p">)</span>
            <span class="n">chla_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;chla_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                              <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="n">meanchla</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;meanchl&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                             <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">chla</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">32767.0</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">chla</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Chlorophyll_a&#39;</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">chla</span><span class="p">,</span> <span class="s1">&#39;standard_name&#39;</span><span class="p">,</span> <span class="s1">&#39;sea_water_chlorophyll_a&#39;</span><span class="p">)</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="n">meanchla</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">999.</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">meanchla</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Mean chlorophyll_a&#39;</span><span class="p">)</span>

            <span class="n">chla</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">chla_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="n">meanchla</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mean</span>
            <span class="k">print</span> <span class="s2">&quot;first data&quot;</span><span class="p">,</span>  <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chla</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;chla&#39;</span><span class="p">]</span>
            <span class="n">chla_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;chla_mask&#39;</span><span class="p">]</span>
            <span class="n">meanchl</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;meanchl&#39;</span><span class="p">]</span>
            <span class="c1"># pdb.set_trace()</span>
            <span class="n">chla</span><span class="p">[</span><span class="n">mynums</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">chla_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="n">meanchl</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mean</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iapp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r488</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r488&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                         <span class="n">fill_value</span><span class="o">=-</span><span class="mf">32767.0</span><span class="p">)</span>
            <span class="n">r488_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r488_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                              <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">r488</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">32767.0</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">r488</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Reflectance at 488nm&#39;</span><span class="p">)</span>
            <span class="n">r488</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">r488_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r488</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;r488&#39;</span><span class="p">]</span>
            <span class="n">r488</span><span class="p">[</span><span class="n">mynums</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">r488_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;r488_mask&#39;</span><span class="p">]</span>
            <span class="n">r488_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iapp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r555</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r555&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                         <span class="n">fill_value</span><span class="o">=-</span><span class="mf">32767.0</span><span class="p">)</span>
            <span class="n">r555_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;r555_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                              <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">r555</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mf">32767.0</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">r555</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Reflectance at 555nm&#39;</span><span class="p">)</span>
            <span class="n">r555</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">r555_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r555</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;r555&#39;</span><span class="p">]</span>
            <span class="n">r555</span><span class="p">[</span><span class="n">mynums</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">r555_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;r555_mask&#39;</span><span class="p">]</span>
            <span class="n">r555_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iapp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fchla</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;fchla&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                          <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                          <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.</span><span class="p">)</span>
            <span class="n">fchla_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;fchla_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                               <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">fchla</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="mf">9999.</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">fchla</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Chlorophyll advection&#39;</span><span class="p">)</span>
            <span class="n">fchla</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">fchla_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fchla</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;fchla&#39;</span><span class="p">]</span>
            <span class="n">fchla</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">fchla_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;fchla_mask&#39;</span><span class="p">]</span>
            <span class="n">fchla</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iapp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f488</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;f488&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                         <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.</span><span class="p">)</span>
            <span class="n">f488_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;f488_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                              <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">f488</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="mf">9999.</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">f488</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Advected reflectance at 488nm&#39;</span><span class="p">)</span>
            <span class="n">f488</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">f488_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f488</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;f488&#39;</span><span class="p">]</span>
            <span class="n">f488</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">f488_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;f488_mask&#39;</span><span class="p">]</span>
            <span class="n">f488_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">iapp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f555</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;f555&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                         <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">),</span>
                                         <span class="n">fill_value</span><span class="o">=</span><span class="mf">9999.</span><span class="p">)</span>
            <span class="n">f555_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;f555_mask&#39;</span><span class="p">,</span> <span class="s1">&#39;f4&#39;</span><span class="p">,</span>
                                              <span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">f555</span><span class="p">,</span> <span class="s1">&#39;missing_value&#39;</span><span class="p">,</span> <span class="mf">9999.</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">f555</span><span class="p">,</span> <span class="s1">&#39;long_name&#39;</span><span class="p">,</span> <span class="s1">&#39;Advected reflectance at 555nm&#39;</span><span class="p">)</span>
            <span class="n">f555</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">f555_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f555</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;f555&#39;</span><span class="p">]</span>
            <span class="n">f555</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data</span>
            <span class="n">f555_mask</span> <span class="o">=</span> <span class="n">ncfile</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;f555_mask&#39;</span><span class="p">]</span>
            <span class="n">f555_mask</span><span class="p">[:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="n">ncfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;exiting generalncwrite2&quot;</span>
    <span class="k">return</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">meanVar</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">obs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**Function to generate multi-day 2D data composites**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        Generalized mean variance function to create a multi-day</span>
<span class="sd">        2D data composite</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        meanVar(mean, num, obs)</span>

<span class="sd">    **Args:**</span>
<span class="sd">        * mean (2D array): running mean</span>
<span class="sd">        * num (2D array): count of number of observations arraygoing into \</span>
<span class="sd">        each cell of the mean</span>
<span class="sd">        * obs (2D array): new data to add to the mean array</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="kn">import</span> <span class="nn">numpy.ma</span> <span class="kn">as</span> <span class="nn">ma</span>

    <span class="n">numShape</span> <span class="o">=</span> <span class="n">num</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
    <span class="n">numAdd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">numShape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">numAdd</span><span class="p">[</span><span class="n">obs</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">numAdd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">tempNum</span> <span class="o">=</span> <span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">num</span> <span class="o">==</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">tempNum</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>

    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">temp</span><span class="o">.</span><span class="n">filled</span><span class="p">(</span><span class="mf">0.</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">single</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_satfiles_list</span><span class="p">(</span><span class="n">L3_DIR</span><span class="p">,</span> <span class="n">sftpURL</span><span class="p">,</span> <span class="n">dmzDest</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;**Function to generate list of fiules to process**</span>

<span class="sd">    **Description:**</span>
<span class="sd">        Makes a list of satellite files on thredds1 that meet the search</span>
<span class="sd">        criteria and compares it to the list of files already created from the</span>
<span class="sd">        satellite files on thredds1. Returns a list of files that have not</span>
<span class="sd">        been processed.</span>

<span class="sd">    **Usage:**</span>
<span class="sd">        get_satfiles_list(L3_DIR, sftpURL, dmzDest)</span>

<span class="sd">    **Args:**</span>
<span class="sd">        * L3_DIR (str):</span>
<span class="sd">        * sftpURL (str): URL to thredds1</span>
<span class="sd">        * dmzDest (str): thredds1 directory containing</span>

<span class="sd">    **Returns:**</span>
<span class="sd">        raw_filelist (list of str): list of files that have not been processed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># from thredds_crawler.crawl import Crawl</span>

    <span class="kn">import</span> <span class="nn">paramiko</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
    <span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">walk</span>

    <span class="c1"># set up dirs</span>
    <span class="k">print</span> <span class="s1">&#39;</span><span class="si">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span><span class="s1">&#39;</span>
    <span class="k">print</span> <span class="s1">&#39;set up dirs&#39;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="c1"># logDir = os.path.join(rootDir, &#39;log&#39;)</span>

    <span class="n">all_l3_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)</span> <span class="ow">in</span> <span class="n">walk</span><span class="p">(</span><span class="n">L3_DIR</span><span class="p">):</span>
        <span class="n">all_l3_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
        <span class="k">break</span>

    <span class="c1"># set up ssh session with thredds</span>
    <span class="k">print</span> <span class="s1">&#39;set up ssh session with thredds1&#39;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tds1Files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">load_system_host_keys</span><span class="p">()</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">sftpURL</span><span class="p">)</span>
            <span class="c1"># make list of files we have on the thredds server</span>
            <span class="k">print</span> <span class="s1">&#39;get list of files on thredds1&#39;</span>
            <span class="n">ftp</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">open_sftp</span><span class="p">()</span>
            <span class="n">ftp</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dmzDest</span><span class="p">)</span>
            <span class="n">tds1Files</span> <span class="o">=</span> <span class="n">ftp</span><span class="o">.</span><span class="n">listdir</span><span class="p">()</span>
            <span class="n">ftp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">raw_filelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">fl</span> <span class="k">for</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">tds1Files</span> <span class="k">if</span> <span class="s1">&#39;A&#39;</span> <span class="o">+</span> <span class="n">fl</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_488.nc&#39;</span>
                            <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_l3_files</span><span class="p">]</span>

            <span class="n">count</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">wait</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">10</span><span class="o">**</span><span class="n">count</span>  <span class="c1"># progressive increase in wait time</span>
            <span class="k">print</span> <span class="s1">&#39;waiting to retry thredds1&#39;</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

    <span class="k">print</span> <span class="s1">&#39;2nd return&#39;</span>
    <span class="k">return</span> <span class="n">raw_filelist</span>
</pre></div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="step3_fn.html"
                        title="previous chapter">EOF Gap-Filling Accessory Modules Documentation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="control_fn.html"
                        title="next chapter">Control Script Documentation</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/step3_lib.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="control_fn.html" title="Control Script Documentation"
             >next</a> |</li>
        <li class="right" >
          <a href="step3_fn.html" title="EOF Gap-Filling Accessory Modules Documentation"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">HABS Forecast Model 1.0 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="hab_project.html" >Satellite Data Processing</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2016, Dr. Dale Robinson.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.5.
    </div>
  </body>
</html>